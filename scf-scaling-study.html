
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scaling study: self-consistent field calculations</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=84ace793992934648b4de8eed757e5a2" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_lesson.css" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="_static/overrides.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/minipres.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/tabs.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.9d8b4a8b9bb19db25eeaddc40d639ba2.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="An overview of electron-repulsion integral evaluation algorithms" href="eri-overview.html" />
    <link rel="prev" title="Performance theory" href="performance-theory.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<div class="col-12 col-md-3 bd-sidebar site-navigation " id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/ENCCS-PDC-logos.jpg" class="logo" alt="logo">
      
      
    </a>
</div><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   VeloxChem: quantum chemistry towards pre-exascale and beyond
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="setup.html">
   Setting up your system
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="hpc-setup.html">
   Setting up VeloxChem on a HPC cluster
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The lesson
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="notebooks/first-steps.html">
   First steps with VeloxChem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="modern-hpc-architectures.html">
   Modern HPC architectures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="performance-theory.html">
   Performance theory
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Scaling study: self-consistent field calculations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="eri-overview.html">
   An overview of electron-repulsion integral evaluation algorithms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="linrsp-scaling-study.html">
   Scaling study: excitation energies with linear response
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="x-ray-cpp.html">
   Complex polarization propagator in the X-ray region
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="exciton.html">
   Exciton calculation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ntos.html">
   Natural transition orbitals
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="quick-reference.html">
   Quick Reference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="zbibliography.html">
   Bibliography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="guide.html">
   Instructor’s guide
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<!-- This is an invisible pixel that we watch to see if we've scrolled. -->
<div class="sbt-scroll-pixel-helper"></div>
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            <div class="topbar-left">
                
                <label class="nav-toggle-button" for="__navigation">
                    <div class="visually-hidden">Toggle navigation</div>
                    <i class="fas fa-bars"></i>
                </label>
                
            </div>
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/scf-scaling-study.rst.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.rst</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ENCCS/veloxchem-hpc"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ENCCS/veloxchem-hpc/issues/new?title=Issue%20on%20page%20%2Fscf-scaling-study.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/ENCCS/veloxchem-hpc/edit/main/content/scf-scaling-study.rst"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#systems-and-input-files">
   Systems and input files
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-the-slurm-scheduler">
     Using the SLURM scheduler
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise">
   Exercise
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Scaling study: self-consistent field calculations</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#systems-and-input-files">
   Systems and input files
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-the-slurm-scheduler">
     Using the SLURM scheduler
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise">
   Exercise
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="section" id="scaling-study-self-consistent-field-calculations">
<span id="scf-scaling-study"></span><h1>Scaling study: self-consistent field calculations<a class="headerlink" href="#scaling-study-self-consistent-field-calculations" title="Permalink to this headline">¶</a></h1>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Learn how to run a self-consistent field (SCF) calculation.</p></li>
</ul>
</div>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>Run a SCF calculation.</p></li>
<li><p>Perform scaling test of the SCF calculation.</p></li>
</ul>
</div>
<p>In this exercise we will run self-consistent field (SCF) calculations
of zinc-porphyrin and oligomers of guanine.</p>
<p>An SCF calculation consists essentially of three parts:</p>
<ol class="arabic">
<li><p>Initial guess for the density matrix <span class="math notranslate nohighlight">\(\mathbf{D}\)</span>,</p></li>
<li><p>Formation of the Fock matrix:</p>
<div class="math notranslate nohighlight">
\[F_{\mu\nu} = h_{\mu\nu} + \sum_{\kappa\lambda} \left[ 2(\mu\nu|\kappa\lambda) - (\mu\kappa|\nu\lambda) \right]D_{\lambda\kappa}\]</div>
<p>by assembling one-electron:</p>
<div class="math notranslate nohighlight">
\[h_{\mu\nu} =
\left\langle
\chi_{\mu}
\left| -\frac{1}{2}\nabla^{2} -\sum_{A=1}^{N_\mathrm{at}} \frac{Z_{A}}{|\mathbf{R}_A - \mathbf{r}|} \right|
\chi_{\nu}
\right\rangle\]</div>
<p>and two-electron integrals:</p>
<div class="math notranslate nohighlight">
\[(\mu\nu|\kappa\lambda) =
\left\langle
\chi_{\mu}(\mathbf{r})\chi_{\nu}(\mathbf{r})
\left| \frac{1}{|\mathbf{r} - \mathbf{r}^{\prime}|} \right|
\chi_{\kappa}(\mathbf{r}^{\prime})\chi_{\lambda}(\mathbf{r}^{\prime})
\right\rangle\]</div>
</li>
<li><p>Diagonalization of Fock matrix and formation of new density matrix.</p></li>
</ol>
<p>While the last step formally scales with the <em>third power</em> of the dimension of
the Fock matrix, it is usually the formation of the matrix itself in step 2
that is the most time-consuming.
The formation of the Fock matrix and in particular the computation of the
electron-repulsion integrals (ERIs) are natural targets for code optimization
and parallelization.</p>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="_images/rh-scf.svg"><img alt="_images/rh-scf.svg" height="71" src="_images/rh-scf.svg" width="632" /></a>
<p class="caption"><span class="caption-text">A schematic view of the SCF algorithm. The formation of the Fock matrix is
the most time-consuming step in the algorithm.</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>VeloxChem adopts a <strong>hybrid MPI+OpenMP</strong> parallelization strategy to achieve
efficient Fock builds:</p>
<ul class="simple">
<li><p>We spread the workload across multiple <strong>nodes</strong> using the <a class="reference external" href="https://en.wikipedia.org/wiki/Message_Passing_Interface">message passing
interface (MPI)</a>.
In this context, a node might be a machine in a blade, a socket, or a NUMA
domain.</p></li>
<li><p>On each node, we spawn multiple <strong>threads</strong> using <a class="reference external" href="https://en.wikipedia.org/wiki/OpenMP">OpenMP</a>. All threads share the memory space
on the node.</p></li>
</ul>
<p>In contrast, the first and third steps are carried out using OpenMP threading on
a single MPI process. <a class="footnote-reference brackets" href="#id2" id="id1">*</a></p>
<p>In this exercise, we want to explore three aspects of the SCF code in VeloxChem:</p>
<ol class="arabic simple">
<li><p><strong>Strong scaling</strong>: how does the time-to-solution change for a fixed-size
problem using an increasing number of workers?  We will use a zinc-porphyrin
system for this investigation.</p></li>
<li><p><strong>Scaling of SCF</strong>: how does the computational cost change when the number
of basis functions increases? We will use a series of guanine oligomers for
this purpose.</p></li>
<li><p>How do MPI and OpenMP settings affect the performance of SCF calculation on
a single node?</p></li>
</ol>
<div class="section" id="systems-and-input-files">
<h2>Systems and input files<a class="headerlink" href="#systems-and-input-files" title="Permalink to this headline">¶</a></h2>
<p>Below is the input file for SCF calculation of zinc porphyrin and guanine oligomers.
You can read more about the VeloxChem input keywords in
<a class="reference external" href="https://veloxchem.org/docs/keywords.html">this page</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">timing</span></code> input option in the SCF section will print out a detailed
breakdown of the time spent within each task of every SCF iteration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@jobs</span>
<span class="n">task</span><span class="p">:</span> <span class="n">scf</span>
<span class="nd">@end</span>

<span class="nd">@method</span> <span class="n">settings</span>
<span class="n">basis</span><span class="p">:</span> <span class="n">def2</span><span class="o">-</span><span class="n">sv</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="nd">@end</span>

<span class="hll"><span class="nd">@scf</span>
</span><span class="hll"><span class="n">timing</span><span class="p">:</span> <span class="n">yes</span>
</span><span class="hll"><span class="nd">@end</span>
</span>
<span class="nd">@molecule</span>
<span class="n">charge</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">multiplicity</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">xyz</span><span class="p">:</span>
</pre></div>
</div>
<dl>
<dt>Zinc porphyrin</dt><dd><p>You can download the full input file with:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/ENCCS/veloxchem-hpc/main/content/inputs/zn-ph.inp
</pre></div>
</div>
<div style="height: 400px; width: 600px; position: relative;" class='viewer_3Dmoljs' data-href='_static/zn-ph.xyz' data-type='xyz' data-backgroundcolor='0xffffff' data-style='stick'></div></dd>
<dt>Guanine oligomers</dt><dd><p>You can download the full input files with:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/ENCCS/veloxchem-hpc/main/content/inputs/g<span class="o">{</span><span class="m">1</span>,2,3,4<span class="o">}</span>.inp
</pre></div>
</div>
<div style="height: 400px; width: 600px; position: relative;" class='viewer_3Dmoljs' data-href='_static/g4.xyz' data-type='xyz' data-backgroundcolor='0xffffff' data-style='stick'></div></dd>
</dl>
<div class="section" id="using-the-slurm-scheduler">
<h3>Using the SLURM scheduler<a class="headerlink" href="#using-the-slurm-scheduler" title="Permalink to this headline">¶</a></h3>
<p>Dardel, as virtually all modern HPC clusters, uses <a class="reference external" href="https://slurm.schedmd.com/overview.html">SLURM</a> as its job scheduler.</p>
<p>A sample submission script:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="ch">#!/bin/bash</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="c1">#SBATCH -J myjob</span>
<span class="hll"><span class="linenos"> 4</span><span class="c1">#SBATCH -t 01:00:00</span>
</span><span class="hll"><span class="linenos"> 5</span><span class="c1">#SBATCH -p main</span>
</span><span class="linenos"> 6</span><span class="c1">#SBATCH -A edu22.veloxchem</span>
<span class="linenos"> 7</span><span class="c1">#SBATCH --reservation velox-lab1</span>
<span class="linenos"> 8</span>
<span class="hll"><span class="linenos"> 9</span><span class="c1">#SBATCH --nodes=1</span>
</span><span class="hll"><span class="linenos">10</span><span class="c1">#SBATCH --ntasks-per-node=8</span>
</span><span class="linenos">11</span>
<span class="linenos">12</span>module load PDC/21.11
<span class="linenos">13</span>module load veloxchem/1.0dev
<span class="linenos">14</span>
<span class="hll"><span class="linenos">15</span><span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">16</span>
</span><span class="hll"><span class="linenos">16</span><span class="nb">export</span> <span class="nv">OMP_PLACES</span><span class="o">=</span>cores
</span><span class="linenos">17</span>
<span class="linenos">18</span><span class="nv">job</span><span class="o">=</span>porphyrin
<span class="linenos">19</span>srun vlx <span class="si">${</span><span class="nv">job</span><span class="si">}</span>.inp <span class="si">${</span><span class="nv">job</span><span class="si">}</span>.out
</pre></div>
</div>
<ul>
<li><p><strong>Line 4</strong> sets the limit on the total runtime of the job allocation.</p></li>
<li><p><strong>Line 5</strong> specifies which <em>partition</em> to be used. <a class="reference external" href="https://www.pdc.kth.se/support/documents/run_jobs/job_scheduling.html#dardel-partitions">Check here</a>
for the partitions available on Dardel.</p></li>
<li><p><strong>Lines 9 and 10</strong> request computational resources:</p>
<ul class="simple">
<li><p>each node consists of <strong>two</strong> AMD EPYC 7742 CPUs, since nodes are
dual-socket on Dardel.</p></li>
<li><p>on each node, we spawn 8 MPI ranks: 4 per socket, since <code class="docutils literal notranslate"><span class="pre">numactl</span>
<span class="pre">--hardware</span></code> showed that each socket is in NPS-4 configuration.</p></li>
</ul>
<p>Thus 8 is the number of MPI ranks which will be used in the calculation.</p>
</li>
<li><p><strong>Line 15</strong> tells to use 16 OpenMP threads on each MPI rank. This ensures
full usage of all cores in the given NUMA domain/MPI rank.</p></li>
<li><p>Finally, <strong>line 16</strong> specifies that threads should be mapped to the cores.</p></li>
</ul>
<p>This sample script will use a single node on Dardel:</p>
<div class="math notranslate nohighlight">
\[\text{1 node} \times \text{8 MPI ranks per node} \times \text{16 OpenMP threads per rank} = \text{128 cores on a node}\]</div>
</div>
</div>
<div class="section" id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h2>
<p>We are going to plot speedup (or scaled speedup) with respect to the number of
nodes used. VeloxChem prints out the total execution time at the end of each
output file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>!========================================================================================================================!
!                               VeloxChem execution completed at Wed Mar  2 10:51:14 2022.                               !
!========================================================================================================================!
!                                          Total execution time is 111.56 sec.                                           !
!========================================================================================================================!
</pre></div>
</div>
<p>With the <code class="docutils literal notranslate"><span class="pre">timing</span></code> option set to <code class="docutils literal notranslate"><span class="pre">yes</span></code> in the input file, you will also get a
detailed breakdown of timings in each SCF iteration:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Timing (in sec)
---------------
                      FockBuild          ERI   CompEnergy     FockDiag
Iteration 1                3.12         3.12         0.04         0.44
Iteration 2                3.50         3.50         0.04         0.48
Iteration 3                3.50         3.50         0.04         0.52
Iteration 4                3.88         3.88         0.04         0.55
Iteration 5                3.88         3.88         0.04         0.58
Iteration 6                3.87         3.87         0.04         0.63
Iteration 7                3.88         3.88         0.04         0.68
Iteration 8                3.87         3.87         0.04         0.74
Iteration 9                3.88         3.87         0.04         0.79
Iteration 10               3.88         3.88         0.04         0.79
Iteration 11               3.88         3.88         0.04         0.81
Iteration 12               3.87         3.87         0.04         0.81
Iteration 13               3.87         3.87         0.04         0.81
Iteration 14               3.87         3.87         0.04         0.81
Iteration 15               3.87         3.87         0.04         0.80
Iteration 16               3.88         3.88         0.04         0.81
Iteration 17               3.87         3.87         0.04         0.81
Iteration 18               3.87         3.87         0.04         0.84
Iteration 19               3.88         3.88         0.04         0.82
Iteration 20               3.87         3.87         0.04
</pre></div>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">Strong scaling: zinc porphyrin</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Scaling of SCF: guanine oligomers</button><button aria-controls="panel-0-0-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-2" name="0-2" role="tab" tabindex="-1">MPI+OpenMP usage</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><ol class="arabic simple">
<li><p>Run the zinc porphyrin example on 1, 2, 3 and 4 nodes.
Use 8 MPI ranks per node and 16 OpenMP threads per rank.</p></li>
<li><p>Gather total execution times from the output files and plot the speedup
against the number of nodes.</p></li>
<li><p>Gather the breakout of timings per SCF iteration from the output files.
Plot the speedup of <code class="docutils literal notranslate"><span class="pre">FockBuild</span></code> with respect to the
number of nodes.</p></li>
</ol>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><ol class="arabic simple">
<li><p>Run the guanine monomer (<code class="docutils literal notranslate"><span class="pre">g1.inp</span></code>), dimer (<code class="docutils literal notranslate"><span class="pre">g2.inp</span></code>), trimer
(<code class="docutils literal notranslate"><span class="pre">g3.inp</span></code>), and tetramer (<code class="docutils literal notranslate"><span class="pre">g4.inp</span></code>) on 1, 2, 3, and 4 nodes,
respectively.
Use 8 MPI ranks per node and 16 OpenMP threads per rank.</p></li>
<li><p>Gather total execution times from the output files and plot the
computational cost (taking into account number of nodes) against
the number of basis functions. Use logarithm scale on both axes.</p></li>
<li><p>Gather the breakout of timings per SCF iteration from the output files.
Plot the computational cost of <code class="docutils literal notranslate"><span class="pre">FockBuild</span></code> with respect to the number
of basis functions.</p></li>
</ol>
</div><div aria-labelledby="tab-0-0-2" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-2" name="0-2" role="tabpanel" tabindex="0"><p>Run the zinc porphyrin example:</p>
<ol class="arabic">
<li><p>Compare the total execution time and the timings for <code class="docutils literal notranslate"><span class="pre">FockBuild</span></code>
obtained using:</p>
<ul>
<li><p>1 node, 8 MPI ranks, 16 OpenMP threads</p></li>
<li><p>1 node, 2 MPI ranks, 64 OpenMP threads</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1">#SBATCH --nodes=1</span>
<span class="c1">#SBATCH --ntasks-per-node=2</span>
<span class="c1">#SBATCH --cpus-per-task=128  # 64x2 because of SMT</span>

<span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">64</span>
<span class="nb">export</span> <span class="nv">OMP_PLACES</span><span class="o">=</span>cores
</pre></div>
</div>
</li>
</ul>
<p>Both calculation setups use one full node on Dardel, but they are not
equally efficient. What might make it so?</p>
</li>
</ol>
</div></div>
<div class="admonition-plotting-your-results callout admonition" id="callout-0">
<p class="admonition-title">Plotting your results</p>
<p>You can launch a <a class="reference external" href="https://mybinder.org/v2/gh/ENCCS/veloxchem-hpc/main?urlpath=lab%2Ftree%2Fcontent%2Fnotebooks">MyBinder instance</a>
to analyze your results in a Jupyter notebook.  You can adapt this sample
script.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># insert your data!</span>
<span class="n">nnodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="c1"># insert your data!</span>
<span class="n">timings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">])</span>
<span class="n">speedup</span> <span class="o">=</span> <span class="n">timings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">timings</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SCF&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">nnodes</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">speedup</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;~%</span><span class="si">{y:.2f}</span><span class="s2">x&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># generate linear fit</span>
<span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">nnodes</span><span class="p">,</span> <span class="n">speedup</span><span class="p">)</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">nnodes</span> <span class="o">+</span> <span class="n">intercept</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">nnodes</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Fit: y = </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">x + </span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;SCF Speedup&quot;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Number of nodes&quot;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Speedup&quot;</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">*</a></span></dt>
<dd><p>MPI processes are usually also called ranks.</p>
</dd>
</dl>
</div>
</div>


              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="performance-theory.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Performance theory</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="eri-overview.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">An overview of electron-repulsion integral evaluation algorithms</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By The contributors<br/>
    
        &copy; Copyright 2022, The contributors.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>